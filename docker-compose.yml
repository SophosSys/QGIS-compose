services:
  nginx:
    image: nginx
    platform: linux/amd64
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - qgis-server-net
    restart: always
    depends_on:
      - qgis-server

  qgis-server:
    build:
      context: ./qgis-server
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: qgis/qgis-server:stable
    platform: linux/amd64
    environment:
      SKIP_NGINX: "true"
      QGIS_SERVER_LOG_STDERR: "1"
      QGIS_SERVER_LOG_LEVEL: "0"
      QGIS_PROJECT_FILE: /io/data/SEL-2.qgz
    volumes:
      - ${PROJECT_DIR}:/io/data
      - ./plugins:/io/plugins
      - ./fonts:/usr/share/fonts
      - ./svg:/var/lib/qgis/.local/share/QGIS/QGIS3/profiles/default/svg
      - ./conf/pg_service.conf:/etc/postgresql-common/pg_service.conf:ro
    networks:
      - qgis-server-net
    restart: always

  qwc2-service:
    image: sourcepole/qwc-map-viewer-demo:v2.0.5
    platform: linux/amd64
    environment:
      # WMS URL exposed to the browser
      REACT_APP_WMS_URL: /qgisserver/
    networks:
      - qgis-server-net
    ports:
      - "${QWC2_SERVICE_PORT}:9090"
    restart: always
    depends_on:
      - qgis-server

  qwc2-ui:
    build: ./qwc2
    volumes:
      - ./qwc2/prod:/usr/share/nginx/html
      - ./qwc2/nginx.conf:/etc/nginx/nginx.conf   # see below
      - ${PROJECT_DIR}:/io/data
    environment:
      # Internal URL for theme generation and health checks
      QGIS_SERVER_URL: http://nginx/
      # Public URL embedded into generated themes
      QGIS_SERVER_PUBLIC_URL: /qgisserver/
    ports:
      - "${QWC2_UI_PORT}:80"
    depends_on:
      - qgis-server
      - qwc2-service
    networks:
      - qgis-server-net
networks:
  qgis-server-net:
